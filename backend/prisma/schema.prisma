// Prisma schema for ATLAS - Gamified LMS Platform
// Database: PostgreSQL 14+

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  FELLOW // Program participant
  FACILITATOR // Cohort facilitator/mentor
  ADMIN // Platform administrator
}

enum ResourceType {
  VIDEO
  ARTICLE
  EXERCISE
  QUIZ
}

enum ResourceState {
  LOCKED // Not yet accessible
  UNLOCKED // Available to access
  IN_PROGRESS // Started but not completed
  COMPLETED // Fully completed
}

enum CohortState {
  PENDING // Not yet started
  ACTIVE // Currently running
  COMPLETED // Finished
  ARCHIVED // Historical record
}

enum EventType {
  RESOURCE_VIEW
  RESOURCE_COMPLETE
  DISCUSSION_POST
  DISCUSSION_COMMENT
  QUIZ_SUBMIT
  CHAT_MESSAGE
  SESSION_ATTEND
}

enum AchievementType {
  MILESTONE // Completion-based (e.g., complete 10 resources)
  STREAK // Consistency-based (e.g., 7-day streak)
  SOCIAL // Engagement-based (e.g., 5 discussion posts)
  LEADERBOARD // Ranking-based (e.g., top 3 in month)
}

// ==================== CORE TABLES ====================

model User {
  id                 String    @id @default(uuid())
  email              String    @unique
  passwordHash       String
  firstName          String
  lastName           String
  role               UserRole  @default(FELLOW)
  cohortId           String?
  currentMonthPoints Int       @default(0) // Points earned this month
  monthlyPointsCap   Int       @default(1000) // Maximum points per month
  lastPointReset     DateTime? // Last time monthly points were reset
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  lastLoginAt        DateTime?

  // Email preferences
  emailNotifications Boolean   @default(true) // General notifications
  weeklyDigest       Boolean   @default(true) // Weekly summary emails
  marketingEmails    Boolean   @default(false) // Marketing communications
  unsubscribeToken   String?   @unique // Token for unsubscribe links
  unsubscribedAt     DateTime? // When user unsubscribed from all emails

  // Relations
  cohort             Cohort?                @relation(fields: [cohortId], references: [id])
  resourceProgress   ResourceProgress[]
  discussions        Discussion[]
  comments           DiscussionComment[]
  discussionLikes    DiscussionLike[]
  pointsLog          PointsLog[]
  userAchievements   UserAchievement[]
  leaderboardEntries LeaderboardEntry[]
  quizResponses      QuizResponse[]
  engagementEvents   EngagementEvent[]
  facilitatedCohorts Cohort[]               @relation("FacilitatorCohorts")
  notifications      Notification[]
  liveQuizParticipants LiveQuizParticipant[]
  attendance         Attendance[]

  @@index([email])
  @@index([cohortId])
  @@index([unsubscribeToken])
  @@map("users")
}

model Cohort {
  id            String      @id @default(uuid())
  name          String // e.g., "April 2026 Cohort A"
  startDate     DateTime
  endDate       DateTime
  state         CohortState @default(PENDING)
  facilitatorId String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  facilitator  User?                @relation("FacilitatorCohorts", fields: [facilitatorId], references: [id])
  fellows      User[]
  sessions     Session[]
  discussions  Discussion[]
  leaderboards MonthlyLeaderboard[]
  channels     Channel[]

  @@index([facilitatorId])
  @@index([state])
  @@map("cohorts")
}

model Session {
  id            String   @id @default(uuid())
  cohortId      String
  sessionNumber Int // 1-16
  title         String // e.g., "Week 1: Career Foundations"
  description   String?
  monthTheme    String? // e.g., "Career Foundations"
  scheduledDate DateTime
  unlockDate    DateTime // 5 days before scheduledDate
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  cohort           Cohort             @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  resources        Resource[]
  discussions      Discussion[]
  quizzes          Quiz[]
  sessionAnalytics SessionAnalytics[]
  liveQuizzes      LiveQuiz[]
  attendance       Attendance[]

  @@unique([cohortId, sessionNumber])
  @@index([cohortId])
  @@index([scheduledDate])
  @@map("sessions")
}

model Resource {
  id                    String       @id @default(uuid())
  sessionId             String
  type                  ResourceType
  title                 String
  description           String?
  url                   String // Link to video/article
  duration              Int? // Minutes for video, estimated read time for article
  estimatedMinutes      Int          @default(10) // Expected time to complete
  minimumTimeThreshold  Int          @default(420) // Minimum seconds required (70% of estimated)
  isCore                Boolean      @default(true) // Core vs optional resource
  pointValue            Int          @default(100)
  order                 Int // Display order within session
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt

  // Relations
  session     Session            @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  progress    ResourceProgress[]
  discussions Discussion[]

  @@index([sessionId])
  @@index([type])
  @@map("resources")
}

model ResourceProgress {
  id                   String        @id @default(uuid())
  userId               String
  resourceId           String
  state                ResourceState @default(LOCKED)
  timeSpent            Int           @default(0) // Seconds
  scrollDepth          Int           @default(0) // Percentage (0-100) for articles
  watchPercentage      Int           @default(0) // Percentage (0-100) for videos
  playbackSpeed        Float         @default(1.0) // Video playback speed (1.0 = normal)
  pauseCount           Int           @default(0) // Number of times video was paused
  seekCount            Int           @default(0) // Number of times user seeked in video
  attentionSpanScore   Float         @default(0.0) // Attention tracking score (0.0-1.0)
  minimumThresholdMet  Boolean       @default(false) // Has user met engagement requirements
  engagementQuality    Float         @default(0.0) // AI quality score (0.0-1.0)
  completedAt          DateTime?
  pointsAwarded        Int           @default(0)
  validatedAt          DateTime? // AI validation timestamp
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([userId, resourceId])
  @@index([userId])
  @@index([resourceId])
  @@index([state])
  @@map("resource_progress")
}

// ==================== SOCIAL LEARNING ====================

model Discussion {
  id              String   @id @default(uuid())
  resourceId      String?
  sessionId       String?
  cohortId        String
  userId          String // Original poster
  title           String
  content         String
  isPinned        Boolean  @default(false)
  isLocked        Boolean  @default(false) // Admin can lock discussions to prevent comments
  qualityScore    Int?     // AI-generated quality score (0-100)
  qualityAnalysis Json?    // AI analysis details
  scoredAt        DateTime? // When AI scoring was completed
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  resource Resource?           @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  session  Session?            @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  cohort   Cohort              @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  user     User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments DiscussionComment[]
  likes    DiscussionLike[]

  @@index([resourceId])
  @@index([sessionId])
  @@index([cohortId])
  @@index([userId])
  @@index([qualityScore])
  @@map("discussions")
}

model DiscussionComment {
  id           String   @id @default(uuid())
  discussionId String
  userId       String
  content      String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  discussion Discussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([discussionId])
  @@index([userId])
  @@map("discussion_comments")
}

model DiscussionLike {
  id           String   @id @default(uuid())
  discussionId String
  userId       String
  createdAt    DateTime @default(now())

  // Relations
  discussion Discussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([discussionId, userId])
  @@index([discussionId])
  @@index([userId])
  @@map("discussion_likes")
}

// ==================== GAMIFICATION ====================

model PointsLog {
  id          String    @id @default(uuid())
  userId      String
  eventType   EventType
  points      Int
  description String // e.g., "Completed: Setting SMART Goals"
  metadata    Json? // Additional context
  createdAt   DateTime  @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
  @@map("points_log")
}

model Achievement {
  id          String          @id @default(uuid())
  name        String
  description String
  type        AchievementType
  iconUrl     String?
  pointValue  Int             @default(0)
  criteria    Json // Flexible criteria (e.g., {resourceCount: 10})
  createdAt   DateTime        @default(now())

  // Relations
  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String   @id @default(uuid())
  userId        String
  achievementId String
  unlockedAt    DateTime @default(now())

  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
  @@map("user_achievements")
}

model MonthlyLeaderboard {
  id        String   @id @default(uuid())
  cohortId  String
  month     Int // 1-12
  year      Int
  startDate DateTime
  endDate   DateTime
  createdAt DateTime @default(now())

  // Relations
  cohort  Cohort             @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  entries LeaderboardEntry[]

  @@unique([cohortId, month, year])
  @@index([cohortId])
  @@map("monthly_leaderboards")
}

model LeaderboardEntry {
  id            String   @id @default(uuid())
  leaderboardId String
  userId        String
  rank          Int
  totalPoints   Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  leaderboard MonthlyLeaderboard @relation(fields: [leaderboardId], references: [id], onDelete: Cascade)
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([leaderboardId, userId])
  @@index([leaderboardId])
  @@index([userId])
  @@index([rank])
  @@map("leaderboard_entries")
}

// ==================== QUIZZES ====================

model Quiz {
  id           String   @id @default(uuid())
  sessionId    String
  title        String
  description  String?
  timeLimit    Int // Minutes
  passingScore Int // Percentage
  pointValue   Int      @default(200)
  multiplier   Float    @default(1.0) // Score multiplier (admin-controlled)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  session   Session        @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  questions QuizQuestion[]
  responses QuizResponse[]

  @@index([sessionId])
  @@map("quizzes")
}

model QuizQuestion {
  id            String   @id @default(uuid())
  quizId        String
  question      String
  options       Json // Array of options
  correctAnswer String
  order         Int
  createdAt     DateTime @default(now())

  // Relations
  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@map("quiz_questions")
}

model QuizResponse {
  id            String   @id @default(uuid())
  quizId        String
  userId        String
  answers       Json // User's answers
  score         Int
  timeBonus     Int      @default(0) // Bonus points from time performance
  passed        Boolean
  pointsAwarded Int      @default(0)
  completedAt   DateTime @default(now())
  timeTaken     Int      @default(0) // Seconds taken to complete

  // Relations
  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@index([userId])
  @@map("quiz_responses")
}

// ==================== ANALYTICS & TRACKING ====================

model EngagementEvent {
  id        String    @id @default(uuid())
  userId    String
  eventType EventType
  metadata  Json // Flexible event data
  createdAt DateTime  @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
  @@map("engagement_events")
}

model SessionAnalytics {
  id                    String    @id @default(uuid())
  sessionId             String
  totalFellows          Int
  fellowsAttended       Int
  avgResourcesCompleted Float
  avgPoints             Float
  
  // AI-Generated Analytics
  transcript            String?
  engagementScore       Float?    // 0-100
  participationRate     Float?    // 0-100
  averageAttention      Float?    // 0-100
  keyTopics             Json?     // Array of key topics extracted by AI
  insights              Json?     // AI-generated insights and recommendations
  participantAnalysis   Json?     // Individual participant engagement data
  questionCount         Int       @default(0)
  interactionCount      Int       @default(0)
  aiProcessedAt         DateTime?
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([aiProcessedAt])
  @@map("session_analytics")
}

model AdminAuditLog {
  id         String   @id @default(uuid())
  adminId    String // User ID of admin
  action     String // e.g., "CREATE_USER", "UPDATE_COHORT"
  entityType String // e.g., "User", "Cohort"
  entityId   String?
  changes    Json? // Before/after values
  createdAt  DateTime @default(now())

  @@index([adminId])
  @@index([action])
  @@index([createdAt])
  @@map("admin_audit_logs")
}

// ==================== CHAT SYSTEM ====================

enum ChannelType {
  COHORT_WIDE // General cohort chat
  MONTHLY_THEME // Month-specific channels
  SESSION_SPECIFIC // Per-session channels
  DIRECT_MESSAGE // 1-on-1 messages (future)
}

model Channel {
  id          String      @id @default(uuid())
  cohortId    String
  type        ChannelType @default(COHORT_WIDE)
  name        String // e.g., "General", "Career Foundations"
  description String?
  sessionId   String? // For SESSION_SPECIFIC channels
  isArchived  Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  cohort   Cohort        @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@index([cohortId])
  @@index([type])
  @@index([sessionId])
  @@map("channels")
}

model ChatMessage {
  id        String   @id @default(uuid())
  channelId String
  userId    String
  content   String
  isDeleted Boolean  @default(false)
  isFlagged Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([userId])
  @@index([createdAt])
  @@map("chat_messages")
}

// ==================== NOTIFICATIONS ====================

enum NotificationType {
  RESOURCE_UNLOCK // New resource available
  QUIZ_REMINDER // Upcoming quiz reminder
  INCOMPLETE_RESOURCE // Resource nearing deadline
  ACHIEVEMENT_EARNED // New achievement unlocked
  DISCUSSION_REPLY // Reply to your discussion/comment
  SESSION_REMINDER // Upcoming session reminder
  LEADERBOARD_UPDATE // Moved up in rankings
  POINT_CAP_WARNING // Approaching monthly point cap
  
  // Admin-specific notifications
  USER_REGISTERED // New user registered
  COHORT_CREATED // New cohort created
  COHORT_UPDATED // Cohort details updated
  RESOURCE_CREATED // New resource created
  RESOURCE_UPDATED // Resource updated
  SESSION_CREATED // New session created
  SESSION_UPDATED // Session updated
  USER_PROMOTED // User role changed
  DISCUSSION_FLAGGED // Discussion flagged for review
  SYSTEM_ALERT // System-level alert
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json? // Additional context (resourceId, achievementId, etc.)
  isRead    Boolean          @default(false)
  isDeleted Boolean          @default(false)
  createdAt DateTime         @default(now())
  readAt    DateTime?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// ==================== LIVE KAHOOT QUIZZES ====================

enum LiveQuizStatus {
  PENDING // Not started yet
  ACTIVE // Currently running
  COMPLETED // Finished
  CANCELLED // Cancelled by facilitator
}

model LiveQuiz {
  id               String        @id @default(uuid())
  sessionId        String
  title            String
  description      String?
  totalQuestions   Int           @default(0)
  timePerQuestion  Int           @default(30) // Seconds per question
  status           LiveQuizStatus @default(PENDING)
  currentQuestion  Int           @default(0) // Current question index (0-based)
  startedAt        DateTime?
  completedAt      DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Relations
  session      Session              @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  questions    LiveQuizQuestion[]
  participants LiveQuizParticipant[]

  @@index([sessionId])
  @@index([status])
  @@map("live_quizzes")
}

model LiveQuizQuestion {
  id            String   @id @default(uuid())
  liveQuizId    String
  questionText  String
  options       Json     // Array of 4 options: [{text: string, isCorrect: boolean, color: string}]
  correctAnswer Int      // Index of correct answer (0-3)
  orderIndex    Int      // Question order in quiz
  timeLimit     Int      @default(30) // Seconds to answer
  pointValue    Int      @default(1000) // Base points for correct answer
  createdAt     DateTime @default(now())

  // Relations
  liveQuiz LiveQuiz            @relation(fields: [liveQuizId], references: [id], onDelete: Cascade)
  answers  LiveQuizAnswer[]

  @@index([liveQuizId])
  @@index([orderIndex])
  @@map("live_quiz_questions")
}

model LiveQuizAnswer {
  id                String   @id @default(uuid())
  participantId     String
  questionId        String
  selectedAnswer    Int      // Index of selected answer (0-3)
  isCorrect         Boolean
  timeToAnswer      Int      // Milliseconds taken to answer
  pointsEarned      Int      // Points with time bonus
  answeredAt        DateTime @default(now())

  // Relations
  participant LiveQuizParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  question    LiveQuizQuestion    @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([participantId, questionId])
  @@index([participantId])
  @@index([questionId])
  @@map("live_quiz_answers")
}

model LiveQuizParticipant {
  id            String   @id @default(uuid())
  liveQuizId    String
  userId        String
  displayName   String
  totalScore    Int      @default(0)
  correctCount  Int      @default(0)
  streak        Int      @default(0) // Current correct answer streak
  rank          Int?     // Final rank (1st, 2nd, 3rd, etc.)
  joinedAt      DateTime @default(now())

  // Relations
  liveQuiz LiveQuiz         @relation(fields: [liveQuizId], references: [id], onDelete: Cascade)
  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  answers  LiveQuizAnswer[]

  @@unique([liveQuizId, userId])
  @@index([liveQuizId])
  @@index([userId])
  @@index([totalScore])
  @@map("live_quiz_participants")
}

// ==================== ATTENDANCE TRACKING ====================

model Attendance {
  id           String    @id @default(uuid())
  userId       String
  sessionId    String
  checkInTime  DateTime  @default(now())
  checkOutTime DateTime?
  latitude     Float? // Optional geolocation data
  longitude    Float?
  ipAddress    String?
  userAgent    String?
  notes        String? // Optional notes from facilitator
  isLate       Boolean   @default(false) // Checked in after scheduled time
  isExcused    Boolean   @default(false) // Excused absence
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([userId, sessionId])
  @@index([userId])
  @@index([sessionId])
  @@index([checkInTime])
  @@map("attendance")
}
